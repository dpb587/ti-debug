<!DOCTYPE html>
<html>
<head>
    <title>ti-debug</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css" rel="stylesheet">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/mootools/1.4.5/mootools.js"></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        window.addEvent('domready', function () {
            var status = $('status'),
                sessions = $('sessions').getFirst('tbody'),
                sessionsEmpty = $('sessions-empty')
            ;
            var detached = io.connect('/index.io');

            function rebuildSessionRow(session) {
                var tr = new Element('tr#session-' + session.id);
                tr.adopt(new Element('td')
                    .adopt(new Element('span', { text : session.title }))
                    .adopt(new Element('br'))
                    .adopt(new Element('small', { text : session.backend.engine.name + '/' + session.backend.engine.version, style : 'color:#666666;font-size:11px;' }))
                );
                tr.adopt(new Element('td')
                    .adopt(new Element('span', { text : session.url }))
                    .adopt(new Element('br'))
                    .adopt(new Element('small', { text : session.startdate, style : 'color:#666666;font-size:11px;' }))
                );

                if (session.attached) {
                    tr.adopt(new Element('td')
                        .adopt(new Element('span', { text : session.attached.title + (session.attached.frontend.status == 'up' ? ' (active)' : '') }))
                        .adopt(new Element('br'))
                        .adopt(new Element('small', { text : session.attached.frontend.engine.name + '/' + session.attached.frontend.engine.version, style : 'color:#666666;font-size:11px;' }))
                    );
                } else if (!session.frontend && session.backend.status == 'up') {
                    tr.adopt(new Element('td').adopt(new Element('a', { text : 'Connect via Browser...', href : session.frontendUrl })));
                } else {
                    tr.adopt(new Element('td').adopt(new Element('span', { text : 'Unavailable' })));
                }

                return tr;
            }

            var cmd = {
                'Session.created' : function (params, animate) {
                    var tr = rebuildSessionRow(params.session).inject(sessions, 'top');
                    sessionsEmpty.setStyle('display', 'none');

                    if (animate !== false) {
                        tr.highlight();
                    }
                },
                'Session.updated' : function (params) {
                    var tr = $('session-' + params.session.id);

                    if (!tr) {
                        return;
                    }

                    rebuildSessionRow(params.session).replaces(tr).highlight();
                }
            }

            new Request.JSON({
                noCache : true,
                url : '/index.json',
                onSuccess : function (data) {
                    data.forEach(function (session) {
                        cmd['Session.created']({ session : session }, false);
                    });
                }
            }).get();

            detached
                .on('connect', function () {
                    status.getElement('span').set('text', 'Connected');
                    status.getElement('div').setStyle('background-color', '#339933');
                    status.getElement('i').set('class', 'icon-leaf icon-white');
                })
                .on('disconnect', function () {
                    status.getElement('span').set('text', 'Not Connected');
                    status.getElement('div').setStyle('background-color', '#993333');
                    status.getElement('i').set('class', 'icon-fire icon-white');
                })
                .on('event', function (data) {
                    console.log('backend %o', data);

                    if ('string' == typeof data) {
                        //data = JSON.decode(data);
                    }

                    cmd[data.method](data.params);
                })
            ;
        });
    </script>
</head>
<body>
    <div class="container">
        <header class="page-header" style="padding-left:8px;padding-right:8px;">
            <div style="position:relative;">
                <div id="status" style="bottom:0;position:absolute;right:0;"><span>Not Connected</span> <div style="background-color:#993333;border-radius:2px;display:inline-block;margin-right:4px;padding:2px 3px 0;"><i class="icon-fire icon-white"></i></div></div>

                <h1>
                    ti-debug
                    <small>v0.3.0</small>
                </h1>
            </div>
        </header>

        <table id="sessions" class="table">
            <thead>
                <tr>
                    <th style="width:30%;">Name</th>
                    <th style="width:50%;">Application</th>
                    <th style="width:20%;">Inspector</th>
                </tr>
            </thead>
            <tbody>
                <tr id="sessions-empty">
                    <td colspan="3">No sessions available.</td>
                </tr>
            </tbody>
        </table>

        <footer style="color:#999999;font-size:11px;">
            <hr style="margin-bottom:0;" />

            <div style="padding:4px 6px;">
                server-side debugging engines using the <a href="http://www.webkit.org/">webkit</a> remote debugger<br />
                open source under <a href="http://opensource.org/licenses/BSD-3-Clause">bsd license</a>
                &nbsp;&ndash;&nbsp; created by <a href="https://github.com/dpb587">danny berger</a>
                &nbsp;&ndash;&nbsp; available at <a href="https://github.com/dpb587/ti-debug">github.com/dpb587/ti-debug</a>
            </div>
        </footer>
    </div>
</body>
</html>
